const handlePayment = async () => {
    if (!selectedNotice) {
      toast.error('No demand notice selected');
      return;
    }

    try {
      setIsProcessing(true);
      toast.info('Initializing payment...');
      
      // Prepare payment data from the selected demand notice
      const paymentData = {
        revenueType: selectedNotice.revenue_type || 'GENERAL_PAYMENT',
        serviceName: selectedNotice.revenue_type || 'General Payment',
        amount: selectedNotice.amount_due,
        payerName: selectedNotice.taxpayer_name,
        payerPhone: selectedNotice.taxpayer_phone,
        payerEmail: selectedNotice.taxpayer_email || undefined,
        businessAddress: selectedNotice.business_address || undefined,
        registrationNumber: selectedNotice.registration_number || undefined,
        zone: selectedNotice.zone ? `zone_${selectedNotice.zone.toLowerCase()}` : undefined,
        notes: `Payment for demand notice ${selectedNotice.notice_number}`
      };

      console.log('üìã Payment data:', paymentData);

      // Try to initialize payment with the local server
      const response = await fetch('http://localhost:3001/initialize-payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(paymentData),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to initialize payment');
      }

      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || 'Payment initialization failed');
      }

      console.log('‚úÖ Payment initialized:', result);
      toast.success('Payment initialized successfully!');
      
      // Redirect to Remita payment page
      if (result.paymentUrl) {
        window.location.href = result.paymentUrl;
      } else {
        throw new Error('No payment URL received');
      }

    } catch (error) {
      console.error('‚ùå Payment error:', error);
      toast.error(error instanceof Error ? error.message : 'Failed to process payment. Please try again.');
    } finally {
      setIsProcessing(false);
    }
  }